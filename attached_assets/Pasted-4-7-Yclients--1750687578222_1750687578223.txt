4.7. Взаимодействие с Yclients (на этапе оформления, после ввода данных клиента и выбора пакета):
* После того как мастер выбрал все параметры, пакет, ввел данные клиента (если требуется сохранение) и нажал кнопку "Оформить абонемент":
* Калькулятор (бэкенд) должен проверить, существует ли в Yclients (через актуальный локальный кэш, полученный из Yclients API) тип абонемента, который полностью соответствует следующим критериям:
1. Состав услуг и их количество: Точное совпадение набора serviceId услуг и их count (количества процедур) из поля balance_container.links ответа Yclients.
2. Настройки типа абонемента в Yclients, эквивалентные "плюшкам" выбранного пакета: Например, параметры allow_freeze, freeze_limit, freeze_limit_unit_id в существующем типе абонемента Yclients должны точно соответствовать настройкам заморозки для выбранного в калькуляторе пакета (VIP, Стандарт, Эконом). Другие релевантные параметры Yclients (например, period, period_unit_id, expiration_type_id, balance_edit_type_id) также должны совпадать, если они зависят от выбранного пакета или являются стандартными для создаваемых калькулятором абонементов.
3. Итоговая стоимость (cost в Yclients): Должна точно совпадать с "Итоговой стоимостью курса", рассчитанной калькулятором для выбранного пакета.
* Если найден существующий тип абонемента, полностью соответствующий всем трем критериям: Калькулятор отображает мастеру его title из Yclients.
* Если такой тип абонемента не найден:
* Калькулятор (бэкенд) формирует запрос на создание нового типа абонемента в Yclients (детали в разделе 6.3).
* title для нового типа абонемента генерируется по стандартизированному шаблону, который должен обеспечивать уникальность и информативность (например, "Пакет[VIP/Стандарт/Эконом]-К[Кол-во процедур]-[Список ID зон через дефис]-[Хэш от состава, цены и ключевых настроек]" - точный шаблон определяется и настраивается в админ-панели).
* cost в запросе к Yclients устанавливается равным "Итоговой стоимости курса", рассчитанной калькулятором.
* Параметры заморозки (allow_freeze, freeze_limit, freeze_limit_unit_id) и другие релевантные поля запроса к Yclients устанавливаются в соответствии с выбранным пакетом (VIP, Стандарт, Эконом) и настройками из админ-панели.
* Бэкенд отправляет POST-запрос на создание типа абонемента в Yclients.
* После успешного создания (и немедленного обновления локального кэша типов абонементов новым созданным типом) калькулятор отображает мастеру title вновь созданного типа абонемента.